<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goida VPN Configs</title>
    <link rel="icon" type="image/png" href="static/images/favicon.png">
    <link rel="apple-touch-icon" href="static/images/favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine Plugins -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script defer src="static/js/update-download-links.js"></script>
    <script defer src="static/js/statistics.js"></script>
    <script defer src="static/js/link-confirmation.js"></script>

    <script>
        // Применить тему ДО отрисовки страницы чтобы избежать мигания
        (function() {
            const darkMode = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (darkMode) {
                document.documentElement.classList.add('dark');
            }
        })();
        
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            blue: '#3670A0',
                            yellow: '#ffdd54',
                            dark: '#0f172a',
                            panel: '#1e293b'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        html {
            scrollbar-gutter: stable;
            transition: background-color 0.3s ease;
        }
        [x-cloak] { display: none !important; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }

        /* Базовые настройки для обоих пятен света */
        body::before, body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            z-index: -1;
            filter: blur(100px); /* Сильное размытие для мягкости */
            opacity: 0.6;
            will-change: transform; /* Оптимизация производительности */
        }

        /* --- СИНЕЕ ПЯТНО (Goida Blue) --- */
        body::before {
            width: 70vw;
            height: 70vw;
            background: radial-gradient(circle, rgba(54, 112, 160, 0.4) 0%, rgba(54, 112, 160, 0) 70%);
            top: -20%;
            left: -20%;
            animation: driftBlue 25s infinite alternate ease-in-out;
        }

        /* --- ЖЕЛТОЕ ПЯТНО (Goida Yellow) --- */
        body::after {
            width: 60vw;
            height: 60vw;
            background: radial-gradient(circle, rgba(255, 221, 84, 0.25) 0%, rgba(255, 221, 84, 0) 70%);
            bottom: -20%;
            right: -20%;
            animation: driftYellow 30s infinite alternate-reverse ease-in-out;
        }

        /* --- НАСТРОЙКИ ДЛЯ ТЕМНОЙ ТЕМЫ --- */
        /* В темной теме делаем цвета чуть менее прозрачными, чтобы они светились на черном фоне */
        body.dark::before {
            opacity: 0.5;
            background: radial-gradient(circle, rgba(54, 112, 160, 0.5) 0%, rgba(54, 112, 160, 0) 70%);
        }

        body.dark::after {
            opacity: 0.3;
            background: radial-gradient(circle, rgba(255, 221, 84, 0.3) 0%, rgba(255, 221, 84, 0) 70%);
        }

        /* --- АНИМАЦИИ --- */
        
        /* Движение синего пятна: Слева-Сверху -> Вниз -> Вправо */
        @keyframes driftBlue {
            0% {
                transform: translate(0, 0) scale(1);
            }
            33% {
                transform: translate(40vw, 20vh) scale(1.2);
            }
            66% {
                transform: translate(10vw, 50vh) scale(0.9);
            }
            100% {
                transform: translate(0, 30vh) scale(1.1);
            }
        }

        /* Движение желтого пятна: Справа-Снизу -> Вверх -> Влево */
        @keyframes driftYellow {
            0% {
                transform: translate(0, 0) scale(1);
            }
            33% {
                transform: translate(-30vw, -20vh) scale(1.3);
            }
            66% {
                transform: translate(-50vw, 10vh) scale(0.8);
            }
            100% {
                transform: translate(-20vw, -40vh) scale(1.1);
            }
        }

        main {
            position: relative;
            z-index: 0;
        }
        .body--lock {
            overflow: hidden;
        }

        /* --- PRELOADER & CRITICAL STYLES --- */
        /* Устанавливаем фон html сразу, чтобы избежать мигания белым до загрузки Tailwind */
        html {
            background-color: #f9fafb; /* gray-50 */
        }
        html.dark {
            background-color: #0f172a; /* brand-dark */
        }

        /* Preloader */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background-color: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
            transition: opacity 0.4s ease-out, visibility 0.4s ease-out;
            will-change: opacity;
        }

        html.dark #preloader {
            background-color: #0f172a;
        }

        /* Класс для скрытия скролла во время загрузки */
        body.loading-state {
            overflow: hidden !important;
        }
    </style>
</head>
<body class="text-gray-900 dark:text-gray-100 transition-colors duration-300 font-sans"
      x-data="{ 
          darkMode: localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches),
          toggleTheme() {
              this.darkMode = !this.darkMode;
              localStorage.setItem('theme', this.darkMode ? 'dark' : 'light');
              if (this.darkMode) document.documentElement.classList.add('dark');
              else document.documentElement.classList.remove('dark');
          },
          activeTab: 'configs',
          showSourcesModal: false,
          showStatsModal: false,
          showExitModal: false,
          showDownloadModal: false,
          targetUrl: '',
          currentSources: [],
          currentConfigId: null,
          lockTimeout: null,
          formatUrl(url) {
              if (!url) return '';
              try {
                  const urlObj = new URL(url);
                  let display = urlObj.hostname + (urlObj.pathname.length > 1 ? urlObj.pathname : '');
                  if (display.length > 40) {
                      return display.substring(0, 20) + '...' + display.substring(display.length - 15);
                  }
                  return display;
              } catch (e) {
                  return url.length > 40 ? url.substring(0, 35) + '...' : url;
              }
          },
          openTargetUrl() {
              if (this.targetUrl) {
                  window.open(this.targetUrl, '_blank');
                  this.showExitModal = false;
                  this.showDownloadModal = false;
              }
          },
          lockBody(state) {
              if (state) {
                  if (this.lockTimeout) clearTimeout(this.lockTimeout);
                  document.body.classList.add('body--lock');
              } else {
                  // Задержка 300мс соответствует стандартной длительности x-transition
                  this.lockTimeout = setTimeout(() => {
                      document.body.classList.remove('body--lock');
                  }, 300);
              }
          }
      }"
      x-init="$watch('darkMode', val => val ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark')); if(darkMode) document.documentElement.classList.add('dark'); $watch('showStatsModal', value => { lockBody(value); if (value) loadGitHubStats(); }); $watch('showExitModal', value => { lockBody(value); }); $watch('showDownloadModal', value => { lockBody(value); }); $watch('showSourcesModal', value => { lockBody(value); });"
      x-on:open-exit-modal.window="targetUrl = $event.detail.url; showExitModal = true"
      x-on:open-download-modal.window="targetUrl = $event.detail.url; showDownloadModal = true"
>
    <!-- Preloader Element -->
    <div id="preloader"></div>

    <script>
        // Блокируем скролл сразу
        document.body.classList.add('loading-state');

        window.addEventListener('load', function() {
            const preloader = document.getElementById('preloader');
            
            // Минимальная задержка для плавности, если сайт загрузился мгновенно
            setTimeout(() => {
                preloader.style.opacity = '0';
                preloader.style.visibility = 'hidden';
                
                // Убираем блокировку скролла после анимации исчезновения
                setTimeout(() => {
                    document.body.classList.remove('loading-state');
                    preloader.remove(); // Удаляем из DOM полностью
                }, 400);
            }, 100);
        });
    </script>

    {% include 'components/header.html' %}

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% block content %}{% endblock %}
    </main>

    <!-- Модальное окно статистики -->
    <div x-show="showStatsModal"
         @keydown.escape="showStatsModal = false"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
         @click.self="showStatsModal = false">
        <div x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             class="bg-white dark:bg-brand-panel rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] flex flex-col">

            <div class="border-b border-gray-200 dark:border-gray-700 p-6 flex items-center justify-between flex-shrink-0">
                <h3 class="text-xl font-black flex items-center gap-3 tracking-tight">
                    <div class="w-10 h-10 rounded-xl bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400">
                        <i class="fa-solid fa-chart-simple"></i>
                    </div>
                    <span>Статистика репозитория</span>
                </h3>
                <button @click="showStatsModal = false"
                        class="w-10 h-10 flex items-center justify-center rounded-xl text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-white/5 transition-all">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto" id="stats-content">
                <!-- Сюда будет загружаться статистика -->
                <div class="text-center py-10">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
                    <p class="text-sm font-bold text-gray-500 animate-pulse">Загрузка данных...</p>
                </div>
            </div>

            <div class="border-t border-gray-200 dark:border-white/10 p-4 flex-shrink-0">
                <button @click="showStatsModal = false"
                        class="w-full py-3 rounded-xl font-bold bg-red-600 hover:bg-red-700 text-white shadow-lg shadow-red-500/20 transition-all active:scale-[0.98]">
                    Закрыть
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно с источниками -->
    <div x-show="showSourcesModal" 
         @keydown.escape="showSourcesModal = false"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
         @click.self="showSourcesModal = false">
        <div x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95 translate-y-4"
             x-transition:enter-end="opacity-100 scale-100 translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100 translate-y-0"
             x-transition:leave-end="opacity-0 scale-95 translate-y-4"
             class="bg-white dark:bg-brand-panel rounded-3xl shadow-2xl max-w-md w-full max-h-[85vh] flex flex-col border border-gray-200 dark:border-white/10 overflow-hidden">
            
            <div class="sticky top-0 bg-white/80 dark:bg-brand-panel/80 backdrop-blur-md border-b border-gray-200 dark:border-white/10 p-6 flex items-center justify-between z-10">
                <h3 class="text-xl font-black flex items-center gap-3 tracking-tight">
                    <div class="w-10 h-10 rounded-xl bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center text-orange-600 dark:text-orange-400 shadow-sm border border-orange-200 dark:border-orange-800/30">
                        <i class="fa-solid fa-book-bookmark"></i>
                    </div>
                    <span>Источники конфига <span class="text-orange-500" x-text="currentConfigId"></span></span>
                </h3>
                <button @click="showSourcesModal = false"
                        class="w-10 h-10 flex items-center justify-center rounded-xl text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-white/5 transition-all">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="p-6 space-y-4 overflow-y-auto">
                <template x-for="(source, index) in currentSources" :key="index">
                    <a :href="source"
                       target="_blank"
                       class="group block p-4 bg-gradient-to-br from-gray-50 to-white dark:from-white/5 dark:to-transparent rounded-2xl border border-gray-100 dark:border-white/10 hover:border-orange-200 dark:hover:border-orange-500/30 hover:shadow-lg hover:shadow-orange-500/5 transition-all duration-300">
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex-1 min-w-0">
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1 group-hover:text-orange-500 transition-colors">Источник #<span x-text="index + 1"></span></p>
                                <p class="text-sm font-bold text-brand-blue dark:text-blue-400 truncate leading-relaxed" x-text="source"></p>
                            </div>
                            <div class="w-8 h-8 rounded-lg bg-gray-100 dark:bg-white/5 flex items-center justify-center text-gray-400 group-hover:bg-orange-100 group-hover:text-orange-600 dark:group-hover:bg-orange-900/30 dark:group-hover:text-orange-400 transition-all">
                                <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i>
                            </div>
                        </div>
                    </a>
                </template>
            </div>

            <div class="sticky bottom-0 bg-white dark:bg-brand-panel border-t border-gray-200 dark:border-white/10 p-4">
                <button @click="showSourcesModal = false"
                        class="w-full py-3 rounded-xl font-bold bg-red-600 hover:bg-red-700 text-white shadow-lg shadow-red-500/20 transition-all active:scale-[0.98]">
                    Закрыть
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения перехода -->
    <div x-show="showExitModal"
         @keydown.escape="showExitModal = false"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
         @click.self="showExitModal = false">
        <div x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95 translate-y-4"
             x-transition:enter-end="opacity-100 scale-100 translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100 translate-y-0"
             x-transition:leave-end="opacity-0 scale-95 translate-y-4"
             class="bg-white dark:bg-brand-panel rounded-3xl shadow-2xl max-w-md w-full p-8 text-center border border-gray-200 dark:border-white/10 relative overflow-hidden">
            
            <div class="absolute -top-24 -left-24 w-48 h-48 bg-blue-500/10 blur-[80px] pointer-events-none"></div>

            <div class="mb-6 relative">
                 <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-2xl bg-blue-100 dark:bg-blue-900/30 text-brand-blue dark:text-blue-400 border border-blue-200 dark:border-blue-800/50 shadow-sm">
                    <i class="fa-solid fa-arrow-up-right-from-square text-2xl"></i>
                </div>
            </div>
            
            <h3 class="text-2xl font-black text-gray-900 dark:text-white mb-3 tracking-tight">Переход на внешний сайт</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-8 leading-relaxed">
                Вы собираетесь перейти на сайт: <br>
                <span class="inline-block mt-3 px-4 py-2 bg-gray-50 dark:bg-black/30 rounded-xl font-mono text-brand-blue dark:text-blue-400 break-all text-xs border border-gray-100 dark:border-white/5" x-text="formatUrl(targetUrl)" :title="targetUrl"></span>
            </p>

            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <button @click="showExitModal = false"
                        class="order-2 sm:order-1 px-6 py-3 rounded-xl font-bold bg-gray-100 dark:bg-white/5 hover:bg-gray-200 dark:hover:bg-white/10 text-gray-700 dark:text-gray-300 transition-all active:scale-95">
                    Отмена
                </button>
                <button @click="openTargetUrl()"
                        class="order-1 sm:order-2 px-6 py-3 rounded-xl font-bold bg-gradient-to-br from-blue-600 to-brand-blue text-white shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 transition-all active:scale-95">
                    Перейти
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения скачивания -->
    <div x-show="showDownloadModal"
         @keydown.escape="showDownloadModal = false"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
         @click.self="showDownloadModal = false">
        <div x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95 translate-y-4"
             x-transition:enter-end="opacity-100 scale-100 translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100 translate-y-0"
             x-transition:leave-end="opacity-0 scale-95 translate-y-4"
             class="bg-white dark:bg-brand-panel rounded-3xl shadow-2xl max-w-md w-full p-8 text-center border border-gray-200 dark:border-white/10 relative overflow-hidden">
            
            <div class="absolute -top-24 -left-24 w-48 h-48 bg-green-500/10 blur-[80px] pointer-events-none"></div>

            <div class="mb-6 relative">
                 <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-2xl bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 border border-green-200 dark:border-green-800/50 shadow-sm">
                    <i class="fa-solid fa-cloud-arrow-down text-2xl"></i>
                </div>
            </div>
            
            <h3 class="text-2xl font-black text-gray-900 dark:text-white mb-3 tracking-tight">Начать скачивание?</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-8 leading-relaxed">
                Вы собираетесь скачать файл с внешнего ресурса: <br>
                <span class="inline-block mt-3 px-4 py-2 bg-gray-50 dark:bg-black/30 rounded-xl font-mono text-green-600 dark:text-green-400 break-all text-xs border border-gray-100 dark:border-white/5" x-text="formatUrl(targetUrl)" :title="targetUrl"></span>
            </p>

            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <button @click="showDownloadModal = false"
                        class="order-2 sm:order-1 px-6 py-3 rounded-xl font-bold bg-gray-100 dark:bg-white/5 hover:bg-gray-200 dark:hover:bg-white/10 text-gray-700 dark:text-gray-300 transition-all active:scale-95">
                    Отмена
                </button>
                <button @click="openTargetUrl()"
                        class="order-1 sm:order-2 px-6 py-3 rounded-xl font-bold bg-gradient-to-br from-green-600 to-emerald-600 text-white shadow-lg shadow-green-500/25 hover:shadow-green-500/40 transition-all active:scale-95">
                    Скачать
                </button>
            </div>
        </div>
    </div>

    {% include 'components/footer.html' %}
</body>
</html>